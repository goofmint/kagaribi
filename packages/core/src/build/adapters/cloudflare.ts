import type { BuildAdapter, BuildGroup, GeneratedFile } from './types.js';
import { exec } from '../exec.js';

export const cloudflareAdapter: BuildAdapter = {
  target: 'cloudflare-workers',

  generateEntry(_group: BuildGroup, appImportPath: string): string {
    return [
      '// Auto-generated by kagaribi. Do not edit.',
      `import app from '${appImportPath}';`,
      '',
      'export default app;',
      '',
    ].join('\n');
  },

  generateConfigs(group: BuildGroup, config?: import('../../types.js').KagaribiConfig): GeneratedFile[] {
    const COMPATIBILITY_DATE = '2024-12-01';
    const lines = [
      `name = "${group.host.name}"`,
      `main = "index.js"`,
      `compatibility_date = "${COMPATIBILITY_DATE}"`,
    ];

    // D1 データベース設定を追加
    if (config?.db?.dialect === 'sqlite' && config.db.driver === 'd1') {
      lines.push('');
      lines.push('[[d1_databases]]');
      lines.push('binding = "DB"');
      lines.push(`database_name = "${group.host.name}-db"`);
      lines.push('database_id = "<your-database-id>"  # wrangler d1 create で取得した ID を設定');
    }

    lines.push('');

    return [
      {
        filename: 'wrangler.toml',
        content: lines.join('\n'),
      },
    ];
  },

  deployInstructions(group: BuildGroup): string {
    return [
      `Build: dist/${group.host.name}/index.js`,
      `Deploy: cd dist/${group.host.name} && wrangler deploy`,
    ].join('\n  ');
  },

  async deploy(distDir: string, group: BuildGroup): Promise<string> {
    const cwd = `${distDir}/${group.host.name}`;
    console.log(`  Deploying ${group.host.name} to Cloudflare Workers...`);
    const { stdout } = await exec('wrangler', ['deploy'], { cwd });

    const urlMatch = stdout.match(/https:\/\/[^\s]+\.workers\.dev/);
    if (!urlMatch) {
      throw new Error(
        `Failed to parse deployed URL from wrangler output.\n${stdout}`
      );
    }
    return urlMatch[0];
  },
};

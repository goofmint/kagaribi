import type { BuildAdapter, BuildGroup, GeneratedFile } from './types.js';
import { exec } from '../exec.js';

export const denoAdapter: BuildAdapter = {
  target: 'deno',

  generateEntry(_group: BuildGroup, appImportPath: string): string {
    return [
      '// Auto-generated by kagaribi. Do not edit.',
      `import app from '${appImportPath}';`,
      '',
      'const port = Number(Deno.env.get("PORT") ?? 8000);',
      'Deno.serve({ port }, app.fetch);',
      '',
    ].join('\n');
  },

  generateConfigs(_group: BuildGroup, _config?: import('../../types.js').KagaribiConfig): GeneratedFile[] {
    return [];
  },

  deployInstructions(group: BuildGroup): string {
    return [
      `Build: dist/${group.host.name}/index.js`,
      `Run:   deno run --allow-net --allow-env dist/${group.host.name}/index.js`,
    ].join('\n  ');
  },

  async deploy(distDir: string, group: BuildGroup): Promise<string> {
    const cwd = `${distDir}/${group.host.name}`;

    console.log(`  Deploying ${group.host.name} to Deno Deploy...`);

    const { stdout } = await exec('deployctl', [
      'deploy',
      `--project=${group.host.name}`,
      'index.js',
    ], { cwd });

    const urlMatch = stdout.match(/https:\/\/[^\s]+\.deno\.dev/);
    if (!urlMatch) {
      throw new Error(
        `Failed to parse deployed URL from deployctl output.\n${stdout}`
      );
    }
    return urlMatch[0];
  },
};

import type { BuildAdapter, BuildGroup, GeneratedFile } from './types.js';
// Node.jsターゲットは自動デプロイ非対応

export const nodeAdapter: BuildAdapter = {
  target: 'node',

  generateEntry(_group: BuildGroup, appImportPath: string): string {
    return [
      '// Auto-generated by kagaribi. Do not edit.',
      `import { serve } from '@hono/node-server';`,
      `import app from '${appImportPath}';`,
      '',
      'const port = Number(process.env.PORT ?? 3000);',
      'serve({ fetch: app.fetch, port });',
      'console.log(`Listening on http://localhost:${port}`);',
      '',
    ].join('\n');
  },

  generateConfigs(_group: BuildGroup, _config?: import('../../types.js').KagaribiConfig): GeneratedFile[] {
    return [];
  },

  deployInstructions(group: BuildGroup): string {
    return [
      `Build: dist/${group.host.name}/index.js`,
      `Run:   PORT=3000 node dist/${group.host.name}/index.js`,
    ].join('\n  ');
  },

  async deploy(_distDir: string, _group: BuildGroup): Promise<string> {
    throw new Error(
      'Node target does not support automated deployment. ' +
      'Use "node dist/<name>/index.js" to run locally, or deploy manually to your server.'
    );
  },
};
